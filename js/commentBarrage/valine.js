function initializeCommentBarrage(){window.commentBarrageInitialized=!0;let e={maxBarrage:1,barrageTime:8e3,valineUrl:GLOBAL_CONFIG.comment.url,pageUrl:window.location.pathname};new class{commentInterval=null;constructor(e){this.config={...e,barrageTimer:[],barrageList:[],barrageIndex:0,dom:document.querySelector(".comment-barrage")},this.commentInterval=null,this.hoverOnCommentBarrage=!1,this.init()}async fetchComments(){const e=new URL(`${this.config.valineUrl}/1.1/classes/Comment`),t={url:this.config.pageUrl,order:"-createdAt"};for(const[r,a]of Object.entries(t))e.searchParams.append(r,a);try{const t=await fetch(e,{method:"GET",headers:{"X-LC-Id":GLOBAL_CONFIG.comment.appId,"X-LC-Key":GLOBAL_CONFIG.comment.appKey,"Content-Type":"application/json"}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return(await t.json()).results.filter((e=>e.url===this.config.pageUrl))}catch(e){console.error("An error occurred while fetching comments: ",e)}}commentLinkFilter(e){return e.flatMap((e=>this.getCommentReplies(e)))}getCommentReplies(e){return window.comment=e,e.replies?[e,...e.replies.flatMap((e=>this.getCommentReplies(e)))]:[e]}processCommentContent(e){const t=e.replace(/```[\s\S]*?```|<blockquote\b[^>]*>[\s\S]*?<\/blockquote>|<[^>]*>|\n|`([^`]{1,9})`:/g,"").trim();return t?`<p>${t}</p>`:""}createCommentBarrage(e){if(!this.processCommentContent(e.comment).trim())return!1;const t=document.createElement("div");return t.classList.add("comment-barrage-item"),t.innerHTML=`\n        <div class="barrageHead">\n            <a class="barrageTitle" href="javascript:sco.scrollTo('post-comment')">${GLOBAL_CONFIG.lang.barrage.title}</a>\n            <div class="barrageNick">${e.nick}</div>\n            <img class="barrageAvatar" src="${GLOBAL_CONFIG.comment.avatar}/avatar/${md5(e.mail.toLowerCase())}"/>\n            <a class="comment-barrage-close" href="javascript:sco.switchCommentBarrage();">\n                <i class="solitude st-close-fill"></i>\n            </a>\n        </div>\n        <a class="barrageContent" href="javascript:sco.scrollTo('${e.objectId}');">${e.comment}</a>\n    `,this.config.dom.appendChild(t),this.config.barrageTimer.push(t),!0}removeCommentBarrage(e){e.className="comment-barrage-item out",setTimeout((()=>{this.config.dom.removeChild(e)}),1e3)}async initCommentBarrage(){const e=document.querySelector(".comment-barrage"),t=(document.querySelector(".menu-commentBarrage-text"),document.querySelector("#consoleCommentBarrage"));null!=localStorage.getItem("commentBarrageSwitch")?(e.style.display="flex",t.classList.add("on")):(e.style.display="none",t.classList.remove("on"));const r=await this.fetchComments();this.config.barrageList=this.commentLinkFilter(r),this.config.dom.innerHTML="",clearInterval(this.commentInterval),this.commentInterval=null;const a=()=>{if(this.config.barrageList.length&&!this.hoverOnCommentBarrage){if(!this.createCommentBarrage(this.config.barrageList[this.config.barrageIndex]))return this.config.barrageIndex=(this.config.barrageIndex+1)%this.config.barrageList.length,a();this.config.barrageIndex=(this.config.barrageIndex+1)%this.config.barrageList.length}this.config.barrageTimer.length>(this.config.barrageList.length>this.config.maxBarrage?this.config.maxBarrage:this.config.barrageList.length)&&!this.hoverOnCommentBarrage&&this.removeCommentBarrage(this.config.barrageTimer.shift())};setTimeout((()=>{a(),this.commentInterval&&clearInterval(this.commentInterval),this.commentInterval=setInterval(a,this.config.barrageTime)}),3e3)}async init(){await this.initCommentBarrage();const e=document.querySelector(".comment-barrage");e.addEventListener("mouseover",(()=>this.hoverOnCommentBarrage=!0)),e.addEventListener("mouseout",(()=>this.hoverOnCommentBarrage=!1))}}(e)}